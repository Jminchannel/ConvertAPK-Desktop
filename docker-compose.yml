services:
  backend:
    build:
      context: .
      dockerfile: web/backend/Dockerfile
    image: convertapk-backend:latest
    environment:
      - TZ=Asia/Shanghai
      - APK_BUILDER_DATA_DIR=/data
      - APK_BUILDER_DATA_VOLUME=convertapk-data
      - APK_BUILDER_GRADLE_CACHE_MODE=volume
      - APK_BUILDER_GRADLE_CACHE_VOLUME=convertapk-gradle-cache
      - ADMIN_API_URL=http://admin-backend:9001
      - ADMIN_CLIENT_TOKEN=client-secret
    volumes:
      - convertapk-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "0.0.0.0:8000:8000"
    depends_on:
      - admin-backend
    restart: unless-stopped

  frontend:
    build:
      context: web/frontend
      dockerfile: Dockerfile
    image: convertapk-frontend:latest
    depends_on:
      - backend
    ports:
      - "0.0.0.0:8080:80"
    restart: unless-stopped

  admin-db:
    image: postgres:15
    environment:
      - TZ=Asia/Shanghai
      - POSTGRES_DB=convertapk_admin
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - admin-db-data:/var/lib/postgresql/data
    restart: unless-stopped

  admin-backend:
    build:
      context: .
      dockerfile: admin/backend/Dockerfile
    image: convertapk-admin-backend:latest
    environment:
      - TZ=Asia/Shanghai
      - DATABASE_URL=postgresql://postgres:postgres@admin-db:5432/convertapk_admin
      - ADMIN_USER=admin
      - ADMIN_PASS=admin123
      - JWT_SECRET=change-me
      - CLIENT_TOKEN=client-secret
      - ADMIN_STORAGE_ROOT=admin-storage
    volumes:
      - admin-storage:/app/admin/backend/admin-storage
    depends_on:
      - admin-db
    ports:
      - "0.0.0.0:9001:9001"
    restart: unless-stopped

  admin-frontend:
    build:
      context: .
      dockerfile: admin/frontend/Dockerfile
    image: convertapk-admin-frontend:latest
    depends_on:
      - admin-backend
    ports:
      - "0.0.0.0:9002:80"
    restart: unless-stopped

  # Build apk-builder image on demand.
  apk-builder:
    profiles: ["builder"]
    build:
      context: apk-worker
      dockerfile: Dockerfile
    image: apk-builder:latest
    entrypoint: ["/bin/bash", "-lc", "echo 'apk-builder image is ready'; sleep infinity"]
    restart: "no"

volumes:
  convertapk-data:
    name: convertapk-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/convertapk
  convertapk-gradle-cache:
    name: convertapk-gradle-cache
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/convertapk/gradle-cache
  admin-db-data:
    name: convertapk-admin-db
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/convertapk-admin/db
  admin-storage:
    name: convertapk-admin-storage
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/convertapk-admin/storage
